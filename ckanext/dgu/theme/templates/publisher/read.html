<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <xi:include href="../facets.html" />
  <py:def function="page_title">${c.group.display_name}</py:def>
  <py:def function="page_heading">${c.group.display_name}
	<a py:if="c.is_superuser_or_groupmember" style="font-size:16px;float:right;" href="${h.url_for('publisher_edit', id=c.group.name)}">Edit</a>
  </py:def>

<?python
    from ckan import model
    sub_groups = sorted([model.Group.get(x['id']) for x in c.group.get_children_groups('publisher')], key=lambda g:g.title)
?>

  <py:match path="primarysidebar">
    <div py:if="c.userobj" class="facet-box">
      <h3>Publisher Administration</h3>

      <h4>Administrators:</h4>
      <ul class="property-list" py:for="admin in c.administrators">
        <li>${h.linked_user(admin)}</li>
      </ul>
      <p py:if="not c.administrators.count()">No-one assigned</p>

      <h4>Editors:</h4>
<?python
import pdb; pdb.set_trace()
?>
      <ul class="property-list" py:for="editor in c.editors">
        <li>${h.linked_user(editor)}</li>
      </ul>
      <p py:if="not c.editors.count()">No-one assigned</p>

      <div py:if="not c.userobj in c.administrators and not c.userobj in c.editors" class="facet-box" style="padding:8px; text-align: center;">
        <a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='apply', id=c.group.name)}">Add this publisher to your account</a>
      </div>

      <div py:if="(c.userobj in c.administrators or c.userobj in c.editors) or c.is_superuser_or_groupmember" class="facet-box" style="padding:8px; text-align: center;">
        <a href="${h.url_for('dataset_new')}?groups__0__id=${c.group.id}">Add a new dataset with this publisher</a>
      </div>

    </div>

    <div py:if="c.is_sysadmin" class="facet-box" style="padding:8px; text-align: center;">
      <h3>System Administrator Tools</h3>
      <a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='report')}">Publisher report</a>
    </div>

    <div py:if="sub_groups" class="facet-box">
      <h3>Sub-Publishers</h3>
      <py:if test="sub_groups">
        <ul id="sub-publishers">
          <li py:for='g in sub_groups[:15]'>
            <a href="${h.url_for('publisher_read', id=g.name)}">${g.title}</a>
          </li>
          <li py:for="g in sub_groups[15:]" class="collapsed">
            <a href="${h.url_for('publisher_read', id=g.name)}">${g.title}</a>
          </li>
        </ul>
        <div style="text-align: center;">
          <a id="sub-publisher-toggle" href="#" py:if="sub_groups[15:]">(${len(sub_groups[15:])} hidden)</a>
        </div>
      </py:if>
      <p py:if="sub_groups">No publishers in the hierarchy underneath this one</p>
    </div>

    ${facet_filters()}

  </py:match>


  <py:match path="content">
    <div py:if="c.parent_publisher">
        <a href="${h.url_for('publisher_read', id=c.parent_publisher.name)}">
            ${c.parent_publisher.title}
        </a>
        |
        <span>
            ${c.group.title}
        </span>
    </div>

    <h3 py:if="c.group['state'] != 'active'">State: ${c.group['state']}</h3>
    <div class="notes" py:if="str(c.description_formatted).strip()">
      ${c.description_formatted}
    </div>

    <a py:if="not c.restricted_to_publisher" href="${c.drill_down_url(publisher=c.group.name)}">Only show ${c.group.title} datasets</a>
    <a py:if="c.restricted_to_publisher"  href="${c.remove_field('publisher', c.group.name)}">Show datasets from ${c.group.title} and sub-publishers</a>

    <div class="group-dataset-list">
      <h3>Datasets</h3>

      <form id="dataset-search" class="dataset-search" method="GET">
        <input type="search" class="search" name="q" value="${c.q}" autocomplete="off" results="0" placeholder="${_('Search...')}" style="width:360px;"/>
        <py:for each="(k, v) in c.fields">
          <input type="hidden" name="${k}" value="${v}" />
        </py:for>
        <input type="submit" value="${_('Search')}" class="pretty-button primary button" />
      </form>
      ${field_list()}

      <p><span py:if="c.q">You searched for "${c.q}". </span>${c.page.item_count} datasets found.</p>
      ${package_list_from_dict(c.page.items)}
      ${c.page.pager()}
    </div>
  </py:match>

  <py:def function="optional_feed">
  <link rel="alternate" type="application/atom+xml" title="${g.site_title} - Datasets in group '${c.group['title']}'"
    href="${h.url(controller='feed', action='group', id=c.group['name'])}" />
  <link rel="alternate" type="application/atom+xml" title="${g.site_title} - Recent Revision History"
    href="${h.url_for(controller='revision', action='list', format='atom', days=1)}" />
  </py:def>

  <xi:include href="../layout.html" />
</html>


