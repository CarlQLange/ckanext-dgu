<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <xi:include href="publisher_util.html" />

  <py:def function="page_title">Publishers</py:def>
  <py:def function="page_heading">Publishers</py:def>

  <py:match path="primarysidebar">
    <li class="widget-container boxed widget_text">
      <h3>Publishers</h3>
      <span i18n:msg="">Datasets are 'published' on data.gov.uk by a range of organisations, mainly from the public sector. On this page you can browse and search for them by name or place in a notional hierarchy.</span>
    </li>
  </py:match>

  <div py:match="content">
    <div class="tabbable">
      <ul class="nav nav-tabs">
        <li class="active"><a href="#publisherlist" data-toggle="tab">Publisher list</a></li>
        <li><a href="#publisherhierarchy" data-toggle="tab">Publisher hierarchy</a></li>
        <li><a href="#publishersearch" data-toggle="tab">Publisher search</a></li>
      </ul>
      <div class="tab-content">
        <div class="tab-pane active" id="publisherlist">
          ${c.page.pager()}
          ${publisher_list(c.page.items)}
        </div>
        <div class="tab-pane" id="publisherhierarchy">
          <div id="publisher-tree">
            ${publisher_tree( c.all_groups )}
          </div>
        </div>
        <div class="tab-pane" id="publishersearch">
<?python
import json
?>
          <input type="text" class="input-medium search-query" data-provide="typeahead" data-items="5" data-source="${json.dumps([group.title for group in c.all_groups])}" id="q" value="${c.q}" autocomplete="off" placeholder="Search..."/>
          <button id="search_button" class="btn btn-primary button" onclick="return  publisher_search();">Search...</button>
          <table id="search_results" class="groups" style="display:none;">
          </table>
        </div>
      </div>
    </div>


  </div>

  <py:def function="optional_head">
    <script src="${g.site_url}/scripts/vendors/jstree/jquery.jstree.js"></script>
    <link rel="stylesheet" href="${g.site_url}/scripts/vendors/jstree/themes/default/style.css" type="text/css" media="screen" />

  <!--[if IE 7]>
    <style>
      .ui-icon { text-indent: 0; }
      .node { padding: 2px; }
    </style>
  <![endif]-->

  <script type="text/javascript">
    function publisher_search() {
      var term = $("#q").val();
      var url = CKAN.SITE_URL + '/api/2/util/group/autocomplete?type=publisher&amp;q=' + escape(term);

      $("#search_results").empty();
      $("#search_results").css("display", "block");
          $.getJSON(url, function(data) {
        $("#search_results").append( '<tr><th>Title</th></tr>' );

              $.each(data, function(idx, groupobj) {
          var tpl =   '<tr><td>' +
                  '<a href="/data/publisher/' + groupobj.name + '">' + groupobj.title +
                '</a></td></tr>';
          $("#search_results").append( tpl );
              });
          });
      return false;
    }

    $(document).ready(function() {
      $( "#tabs" ).tabs( {
        show: function(e, ui) { if ( ui.index == 2 ) { $("#q").focus(); } }
      });

      $("#publisher-tree").jstree(
         {"plugins" : ["themes","html_data","ui"]}
      ).delegate('a', 'click', function(e){ window.location.href=$(this).attr('href'); });

      $("#q").keypress(function(e) {  if (e.which == 13) publisher_search(); });

      $('.typeahead').typeahead({
            onselect: function (obj) {
            publisher_search()
            }
      })
    });
  </script>
  </py:def>

  <xi:include href="../layout.html" />
</html>
