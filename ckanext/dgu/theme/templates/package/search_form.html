<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip=""
  >

  <table class="search-area">
    <tr>
      <td class="left" py:if="not c.query_error">
        <div class="result-count">${c.page.item_count if c.page not in (None, '') else c.package_count or 0}</div>
        <py:if test="request.params">      
          <div class="result-count-footer">Results</div>
        </py:if>
        <py:if test="not request.params">      
          <div class="result-count-footer">Datasets</div>
        </py:if>
      </td>
      <td class="left" py:if="c.query_error">
        <div class="result-count-footer">Search Error</div>
      </td>
      <td class="right">
        <form id="dataset-search" class="form-search dataset-search" action="${h.url_for(controller='package', action='search')}" method="GET">
          <input id="q" data-provide="typeahead" type="text" class="input-medium" name="q" value="${c.q}" results="0" placeholder="${_('Search...')}" />
          <div class="search-spinner">&nbsp;</div>
          <input type="submit" value="${_('Search')}" class="btn btn-primary button" />
          <span py:if="c.fields">
          <py:for each="(k, v) in c.fields"> 
            <input type="hidden" name="${k}" value="${v}" />  
          </py:for>
          </span>
<?python
bbox = request.params.get('ext_bbox','')
?>
          <py:if test="bbox">
            <input type="hidden" id="ext_bbox" name="ext_bbox" value="${bbox}" />
          </py:if>
          <div id="dataset-search-ext"></div>
        </form>
        <div class="search-facets">
          <div class="rss-link">
          </div>
          <div class="pull-left" style="padding-top: 5px;" py:if="c.fields">Your search:</div>
          <div class="pull-left" style="width: 80%;">
            <py:for each="(field, value) in c.fields">
              <a class="facet" href="${c.remove_field(field, value)}">
                <span class="name">${h.facet_title(field)}</span>:
                <span class="value">${value}</span>
                <span class="x">x</span>
              </a>
            </py:for>
            <py:if test="bbox">
              <a class="facet" href="${c.remove_field('ext_bbox', bbox)}">
                <span class="name">${h.facet_title('Location')}</span>:
                <span class="value">${bbox}</span>
                <span class="x">x</span>
              </a>
            </py:if>
          </div>
          <div class="clearfix"></div>
        </div>
      </td>
    </tr>
  </table>

  <script src="/scripts/bootstrap-typeahead.js"></script>
  <script type="text/javascript">
    $(function() {
      // Singleton object to handle spinner animation. Call start() and stop()
      var SearchSpinner = {
        el: $('.search-spinner')[0],
        config: {
          lines: 9, // The number of lines to draw
          length: 4, // The length of each line
          width: 2, // The line thickness
          radius: 3, // The radius of the inner circle
          rotate: 0, // The rotation offset
          color: '#000', // #rgb or #rrggbb
          speed: 2, // Rounds per second
          trail: 60, // Afterglow percentage
          shadow: false, // Whether to render a shadow
          hwaccel: false, // Whether to use hardware acceleration
          className: 'spinner', // The CSS class to assign to the spinner
          zIndex: 2e9, // The z-index (defaults to 2000000000)
          top: 'auto', // Top position relative to parent in px
          left: 'auto' // Left position relative to parent in px
        },
        active: null,
        start: function() {
          if (this.active) return;
          this.active = new Spinner(this.config).spin(this.el);
        },
        stop: function() {
          if (!this.active) return;
          this.active.stop();
          this.active = null;
        }
      };

      var input = $('#dataset-search #q');
      var url = '/api/2/search/dataset';

      var pollApi = function(typeahead,query) {
        $.ajax({
          url: url, 
          data: { fl: 'title', q: query }, 
          success: function (data) {
            var array = data.results;
            var out = [];
            var i=0;
            while (!(i==array.length)) {
              out.push(array[i++].title);
            }
            typeahead.process(out);
            SearchSpinner.stop();
          }
        });
      };

      var runningTimeout = null;

      var sourceFunction = function (typeahead, query) {
        if (runningTimeout) {
          clearTimeout(runningTimeout);
          runningTimeout = null;
        }
        if (!query) {
          SearchSpinner.stop();
          return [];
        }
        SearchSpinner.start();
        runningTimeout = setTimeout(function() { pollApi(typeahead,query); }, 200);
      };

      input.typeahead({
        source: sourceFunction
      });

    });
  </script>

</html>
