<html xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  py:strip=""
  >
  <xi:include href="../_util.html" />
  <xi:include href="basket.html" />

  <div id="dataset"><!--! id=dataset for ckanext-spatial -->
    <!-- Overview Section -->
    <div id="dataset-overview">

        <?python
            class DatasetFieldNames:
                def __init__(self):
                    self._field_names = ['url', 'author', 'maintainer', 'foi_contact', 'version', 'country', 'license', 'contact', 'theme', 'mandate', 'temporal_coverage', 'geographic_coverage', 'date_released', 'date_updated']
                def add(self, field_names):
                    self._field_names.extend(field_names)
                def add_after(self, field_name_to_insert_after, field_name_to_insert):
                    index = self._field_names.index(field_name_to_insert_after)
                    self._field_names.insert(index, field_name_to_insert)
                def remove(self, field_names):
                    for field_name in field_names:
                        self._field_names.remove(field_name)
                def __iter__(self):
                    for field_name in self._field_names:
                        yield field_name

            class DatasetFields:
                def __init__(self, field_names):
                    self.fields = []
                    for field_name in field_names:
                        value_dict = field_value_map.get(field_name, {})
                        value_dict['name'] = field_name
                        self.fields.append(value_dict)
                    # move blank values last
                    blank_values = []
                    for field in self.fields[:]:
                        if not field.get('value'):
                            blank_values.append(field)
                            self.fields.remove(field)
                    self.fields.extend(blank_values)
                def __iter__(self):
                    for field in self.fields:
                        value_attributes = {'property': field.get('property')} if 'property' in field else {}
                        label_attributes = {'title': field['label_title']} if 'label_title' in field else {}
                        yield (field, label_attributes, value_attributes)

            field_names = DatasetFieldNames()
            # work out the dataset_type
            dataset_type = 'form' # default - entered via the form
            pkg_extras = dict(c.pkg_extras)
            if pkg_extras.get('UKLP') == 'True' or pkg_extras.get('INSPIRE') == 'True':
                dataset_type = 'uklp'
                harvest_object_id = pkg_extras.get('harvest_object_id')
                field_names.add(['harvest_source', 'bbox', 'spatial-reference-system', 'metadata_date', 'dataset-reference-date', 'frequency-of-update', 'responsible-party', 'spatial-data-service-type', 'metadata-language'])
                field_names.add_after('license', 'access_constraints')
                field_names.remove(['foi_contact', 'geographic_coverage', 'country'])
            elif pkg_extras.get('external_reference') == 'ONSHUB':
                dataset_type = 'ons'
                field_names.add(['national_statistic'])
                field_names.remove(['country'])
            if h.check_access('package_update',{'id':c.pkg.id}):
                field_names.add(['state'])

            field_value_map = {
                # field_name : {display info}
                'url': {'label': 'Source', 'value': c.pkg_url_link, 'property': 'foaf:homepage'},
                'author': {'label': 'Author', 'value': c.pkg_author_link, 'property': 'dc:creator'},
                'maintainer': {'label': 'Maintainer', 'value': c.pkg_maintainer_link, 'property': 'dc:contributor'},
                'version': {'label': 'Version', 'value': c.pkg.version},
                'foi_contact': {'label': 'FOI Contact', 'label_title': 'Contact details for requests under the Freedom of Information Act', 'value': pkg_extras.get('foi_contact')},
                'country': {'label': 'Country', 'value': 'h.code_to_country(c.eu_country)'},
                'state': {'label': 'State', 'value': c.pkg.state},
                'harvest_source': {'label': 'Harvest Source', 'value': '<a href="%s">Dataset page</a> on <a href="%s">%s</a>' % (c.harvest_dataset_url, c.harvest_catalogue_url, c.harvest_catalogue_name)},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
                '': {'label': '', 'value': ''},
            }

            # calculate displayable field values
            fields = DatasetFields(field_names)
        ?>
      <!-- Optional logo -->
      <div py:if="dataset_type == 'ons' and pkg_extras.get('national_statistic', '').lower() == 'yes'">
        <a href="http://www.statistics.gov.uk/hub/what-are-national-statistics-/index.html">
          <img src="/images/national_statistics.gif" />
        </a>
      </div>
      <div py:if="dataset_type == 'uklp'">
        <a href="/location">
          <img src="/images/uk_location.gif" />
        </a>
      </div>

      <!-- Description -->
      <div py:if="str(c.pkg_notes_formatted).strip()">
        <h3>Description</h3>
        <div class="notes">
          ${c.pkg_notes_formatted}
        </div>
      </div>

      <!-- Resources -->
      <div id="dataset-resources" class="resources subsection">
        <py:if test="individual_resources or not timeseries_resources">
          <h3>Data Resources (${len(individual_resources)})</h3>
          <ul class="resource-list">
            <py:for each="res in individual_resources">
            <li>
              <a class="resource-title" href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id'])}">
                ${h.icon('page_white')}
                ${h.resource_display_name(res)}
                <span py:if="res.get('format')" class="format-box" property="dc:format">${res.get('format')}</span>
              </a>
              <div class="resource-buttons">
                <a href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id'])}" class="href-action btn btn-small btn-black-text">Details</a>
                <a href="${res.get('url', '')}" class="href-action btn btn-small btn-primary">Download</a>
              </div>
              </li>
            </py:for>
          </ul>
        </py:if>
        <py:if test="timeseries_resources">
          <h3>Data Resources (${len(timeseries_resources)} in a time series)</h3>
          <ul class="resource-list">
            <py:for each="res in timeseries_resources">
            <li>
              <a class="resource-title" href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id'])}">
                ${h.icon('page_white')}
                ${res.get('date')}
                ${h.resource_display_name(res)}
                <span py:if="res.get('format')" class="format-box" property="dc:format">${res.get('format')}</span>
              </a>
              <div class="resource-buttons">
                <a href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id'])}" class="href-action btn btn-small btn-black-text">Details</a>
                <a href="${res.get('url', '')}" class="href-action btn btn-small btn-primary">Download</a>
              </div>
              </li>
            </py:for>
          </ul>
        </py:if>

        ${map_preview_buttons(c.pkg.id, c.pkg_dict)} <!--! Supply both since there is no ID in pkg_dict! -->

        <py:if test="additional_resources or dataset_type == 'uklp'"> 
          <h3>Additional Links (${len(additional_resources)})</h3>
          <ul class="resource-list">
            <py:for each="res in additional_resources">
            <li>
              <a class="resource-title" href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id'])}">
                ${h.icon('page_white')}
                ${res.get('date')}
                ${h.resource_display_name(res)}
                <span py:if="res.get('format')" class="format-box" property="dc:format">${res.get('format')}</span>
              </a>
              <div class="resource-buttons">
                <a href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id'])}" class="href-action btn btn-small btn-black-text">Details</a>
                <a href="${res.get('url', '')}" class="href-action btn btn-small btn-primary">Download</a>
              </div>
              </li>
            </py:for>
          </ul>
          <ul class="resource-list">
              <li>
                <a href="/api/2/rest/harvestobject/${harvest_object_id}/xml" rel="dcat: distribution" target="_blank">
                  ${h.icon('page_white')}
                  Source GEMINI2 record
                  <span class="format-box" property="dc:format">XML</span>
                  <div class="resource-buttons">
                    <a href="/api/2/rest/harvestobject/${harvest_object_id}/xml" class="href-action btn btn-small btn-primary" rel="dcat: distribution" target="_blank">Download</a>
                  </div>
                </a>

              </li>
              <li>
                <a href="/api/2/rest/harvestobject/${harvest_object_id}/html" rel="dcat: distribution" target="_blank">
                  ${h.icon('page_white')}
                  Source GEMINI2 record (formatted)
                  <span class="format-box" property="dc:format">HTML</span>
                  <div class="resource-buttons">
                    <a href="/api/2/rest/harvestobject/${harvest_object_id}/html" class="href-action btn btn-small btn-primary" rel="dcat: distribution" target="_blank">View</a>
                  </div>
                </a>

              </li>
          </ul>
         </py:if>

        <py:if test="not (dataset_type == 'uklp' or individual_resources or timeseries_resources or additional_resources)">
          <em>(none)</em>
        </py:if>
      </div>

    </div>

    <!-- Dataset Information Section -->
    <h3>Additional Information</h3>
    <div id="dataset-information">
    <table class="table table-bordered table-striped table-condensed table-dgu-fixed-size">
      <tbody>
        <tr py:for="field_dict, label_attributes, value_attributes in fields">
          <td class="dataset-label" py:attrs="label_attributes">${field_dict.get('label') or field_dict['name']}</td>
          <td class="dataset-details" py:attrs="value_attributes">${field_dict.get('value') or 'No value'}</td>
        </tr>
      </tbody>
    </table>

    <table class="table table-bordered table-striped table-condensed table-dgu-fixed-size">
      <tbody>
        <tr py:if="c.pkg.url">
          <td class="dataset-label">Source</td>
          <td class="dataset-details" property="foaf:homepage">${c.pkg_url_link}</td>
        </tr>

        <tr py:if="c.pkg_author_link">
          <td class="dataset-label">Author</td>
          <td class="dataset-details" property="dc:creator">${c.pkg_author_link}</td>
        </tr>

        <tr py:if="c.pkg_maintainer_link">
          <td class="dataset-label">Maintainer</td>
          <td class="dataset-details" property="dc:contributor">${c.pkg_maintainer_link}</td>
        </tr>

        <tr py:if="c.pkg.version">
          <td class="dataset-label">Version</td>
          <td class="dataset-details">${c.pkg.version}</td>
        </tr>

        <tr py:if="c.eu_country">
          <td class="dataset-label">Country</td>
          <td class="dataset-details"><!--{h.code_to_country(c.eu_country)}--></td>
        </tr>

        <tr py:if="h.check_access('package_update',{'id':c.pkg.id})">
          <td class="dataset-label">State</td>
          <td class="dataset-details">${c.pkg.state}</td>
        </tr>

        <tr py:if="c.harvest_catalogue_name">
          <td class="dataset-label">Harvest Source</td>
          <td class="dataset-details">
            <a href="${c.harvest_dataset_url}">Dataset page</a> on 
            <a href="${c.harvest_catalogue_url}">${c.harvest_catalogue_name}</a>
          </td>
        </tr>

        <tr py:for="i, (key, value) in enumerate(c.pkg_extras)"
          rel="dc:relation" resource="_:extra${i}">
          <td class="dataset-label" property="rdfs:label">${_(key)}</td>
          <td class="dataset-details" property="rdf:value">${value}</td>
        </tr>
      </tbody>
    </table>

    </div>

    <div id="api-information">
        <h3>Developer Tools</h3>
        <div>
            <p>
                The information on this page (the dataset metadata) is also
                available in JSON format:<br/>
                <code>
                  <a href="h.url_for(controller='api', register='package', action='show', id=c.pkg.name, ver='2')}">
                    ${h.url_for(controller='api', register='package', action='show', id=c.pkg.name, ver='2')}
                  </a>
                </code>
            </p>
            <p>
                Read more about this site's CKAN API: <a
                  href="${h.url_for(controller='ckanext.dgu.controllers.data:DataController', action='api')}">About the API</a>
            </p>
            <p>
                This dataset has a permanent URI:<br/>
                <code>
                  <a href="${h.url_for(controller='package', action='read', id=c.pkg.name)}">
                      ${g.site_url}${h.url_for(controller='package', action='read', id=c.pkg.name)}
                  </a>
                </code>
            </p>
        </div>
    </div>

  </div> <!-- /dataset -->

</html>
