<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip=""
  >
  <?python
if c.pkg_dict:
    class DatasetFieldNames:
        def __init__(self):
            self._field_names = ['url', 'author', 'maintainer', 'foi_contact', 'version', 'country', 'license', 'contact', 'theme', 'mandate', 'temporal_coverage', 'geographic_coverage', 'date_released', 'date_updated']
        def add(self, field_names):
            self._field_names.extend(field_names)
        def add_after(self, field_name_to_insert_after, field_name_to_insert):
            index = self._field_names.index(field_name_to_insert_after)
            self._field_names.insert(index, field_name_to_insert)
        def remove(self, field_names):
            for field_name in field_names:
                self._field_names.remove(field_name)
        def __iter__(self):
            for field_name in self._field_names:
                yield field_name
    
    class DatasetFields:
        def __init__(self, field_names):
            self.fields = []
            for field_name in field_names:
                value_dict = field_value_map.get(field_name, {})
                value_dict['name'] = field_name
                self.fields.append(value_dict)
            # move blank values last
            blank_values = []
            for field in self.fields[:]:
                if not field.get('value'):
                    blank_values.append(field)
                    self.fields.remove(field)
            self.fields.extend(blank_values)
        def __iter__(self):
            for field in self.fields:
                value_attributes = {'property': field.get('property')} if 'property' in field else {}
                label_attributes = {'title': field['label_title']} if 'label_title' in field else {}
                yield (field, label_attributes, value_attributes)
    
    field_names = DatasetFieldNames()
    # work out the dataset_type
    dataset_type = 'form' # default - entered via the form
    pkg_extras = dict(c.pkg_extras)
    if pkg_extras.get('UKLP') == 'True' or pkg_extras.get('INSPIRE') == 'True':
        dataset_type = 'uklp'
        harvest_object_id = pkg_extras.get('harvest_object_id')
        field_names.add(['harvest_source', 'bbox', 'spatial-reference-system', 'metadata_date', 'dataset-reference-date', 'frequency-of-update', 'responsible-party', 'spatial-data-service-type', 'metadata-language'])
        field_names.add_after('license', 'access_constraints')
        field_names.remove(['foi_contact', 'geographic_coverage', 'country'])
    elif pkg_extras.get('external_reference') == 'ONSHUB':
        dataset_type = 'ons'
        field_names.add(['national_statistic'])
        field_names.remove(['country'])
    if h.check_access('package_update',{'id':c.pkg.id}):
        field_names.add(['state'])
    
    field_value_map = {
        # field_name : {display info}
        'url': {'label': 'Source', 'value': c.pkg_url_link, 'property': 'foaf:homepage'},
        'author': {'label': 'Author', 'value': c.pkg_author_link, 'property': 'dc:creator'},
        'maintainer': {'label': 'Maintainer', 'value': c.pkg_maintainer_link, 'property': 'dc:contributor'},
        'version': {'label': 'Version', 'value': c.pkg.version},
        'foi_contact': {'label': 'FOI Contact', 'label_title': 'Contact details for requests under the Freedom of Information Act', 'value': pkg_extras.get('foi_contact')},
        'country': {'label': 'Country', 'value': 'h.code_to_country(c.eu_country)'},
        'state': {'label': 'State', 'value': c.pkg.state},
        'harvest_source': {'label': 'Harvest Source', 'value': '<a href="%s">Dataset page</a> on <a href="%s">%s</a>' % (c.harvest_dataset_url, c.harvest_catalogue_url, c.harvest_catalogue_name)},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
        '': {'label': '', 'value': ''},
    }
    
    # calculate displayable field values
    fields = DatasetFields(field_names)


    # DGU sometimes provides no resources, just these three objects
    individual_resources = c.pkg_dict.get('individual_resources', [])
    timeseries_resources = c.pkg_dict.get('timeseries_resources', [])
    additional_resources = c.pkg_dict.get('additional_resources', [])
    if dataset_type=='uklp':
        gemini_resources = [
            {'url': '/api/2/rest/harvestobject/%s/xml' % harvest_object_id,
             'title': 'Source GEMINI2 record',
             'type': 'XML',
             'action': 'Download',
             'id': ''},
            {'url': '/api/2/rest/harvestobject/%s/html' % harvest_object_id,
             'title': 'Source GEMINI2 record (formatted)',
             'type': 'HTML',
             'action': 'View',
             'id': ''}]
    else:
        gemini_resources = []

    # Hack. I cannot clearly tell why sometimes the resources are defined by the three keys (above)
    #   and other times defined by 'resources'. I think a plugin toggles it. Without this line,
    #   no resources are rendered by read_core.
    if not individual_resources and not timeseries_resources and not additional_resources:
        individual_resources = c.pkg_dict.get('resources', [])

    # Core CKAN expects a resource dict to render in the navigation
    if not 'resources' in c.pkg_dict:
        c.pkg_dict['resources'] = individual_resources + timeseries_resources + additional_resources + gemini_resources
?>

  <py:match path="minornavigation" py:if="c.pkg">
    <ul class="nav nav-pills">
      <li class="${'active' if c.action=='read' else ''}">${h.subnav_link(h.icon('package') + _('View'), controller='package', action='read', id=c.pkg.name)}</li>
      <py:choose test="len(c.pkg_dict.get('resources', []))==0 and not h.check_access('package_update',{'id':c.pkg.id})">
      <py:when test="True">
        <li class="disabled">
          <a href="#" onclick="return false;">${h.icon('package-disabled') + _('Resources (0)')}</a>
        </li>
      </py:when>
      <py:otherwise>
        <li class="dropdown ${'active' if (c.action=='resource_read' or c.action=='editresources') else ''}">
          <a class="dropdown-toggle" data-toggle="dropdown" href="#">${h.icon('page_white_stack') + _('Resources') + ' (' + str(len(c.pkg_dict.get('resources',[]))) + ')'}<b class="caret"></b></a>
          <div class="dropdown-appears">
            <ul class="dropdown-menu">
              <li py:for="res in c.pkg_dict.get('resources', [])">
                <a href="${h.url_for(controller='package', action='resource_read', id=c.pkg_dict['name'], resource_id=res['id']) if res.get('id') else '#'}">${h.resource_icon(res) + h.resource_display_name(res)}</a>
              </li>
            </ul>
          </div>
        </li>
      </py:otherwise>
      </py:choose>
      <li class="${'active' if c.action=='history' else ''}">${h.subnav_link(h.icon('page_stack') + _('History'), controller='package', action='history', id=c.pkg.name)}</li>
      <py:if test="h.check_access('package_update',{'id':c.pkg.id})">
        <li class="divider">|</li>
        <li class="${'active' if c.action=='edit' else ''}">
          ${h.subnav_link(h.icon('package_edit') + _('Edit'), controller='package', action='edit', id=c.pkg.name)}
        </li>
      </py:if>
      <li class="${'active' if c.action=='authz' else ''}" py:if="h.check_access('package_edit_permissions',{'id':c.pkg.id})">
        ${h.subnav_link(h.icon('lock') + _('Authorization'), controller='package', action='authz', id=c.pkg.name)}
      </li>
    </ul>
  </py:match>
  
  <xi:include href="../layout.html" />

</html>

