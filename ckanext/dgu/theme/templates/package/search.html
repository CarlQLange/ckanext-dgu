<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip="">

  <xi:include href="../facets.html" />

  <py:def function="page_title">Data Search | data.gov.uk</py:def>
  <py:def function="page_heading">Data Search</py:def>
  <py:def function="optional_head">
    <script src="/scripts/spin.min.js"></script>
    <script src="/scripts/dgu-basket.js?1"></script>
    <link type="text/css" rel="stylesheet" media="all" href="/scripts/vendor/jqueryui/1.8.14/css/jquery-ui.custom.css" />
  </py:def>

  <py:def function="body_class">no-sidebar</py:def>

  <py:def function="content_class"><!--unboxed--></py:def>

  <div py:match="content">
    <div class="row">
      <div class="span12">
        <div class="boxed search-area-box">
          <xi:include href="search_form.html" />
        </div>
        <div class="clearfix"></div>
      </div>
    </div>
    <div class="row">
      <div class="span4">
        ${basket()}


        <py:if test="c.page.item_count">
          <div id="filter-heading">
            <p>You can refine your search results using the filters below</p>
          </div>

          ${facet_filters()}
        </py:if>
      </div>
      <div class="span8">
        <py:if test="c.query_error">
          <p i18n:msg="item_count"><strong>There was an error while searching.</strong>
              Please try again.</p>
        </py:if>
        <div class="ribbon-header sort-by-controls" py:if="c.page.item_count">
          <a class="feed-icon" href="${h.url(controller='feed', action='custom')}?${c.search_url_params}">
            <img src="/images/rss-on-white.png" alt="Syndicate content" title="Search results" width="16" height="16"/>
          </a>
          <h4>Sort by</h4>
<?python
# Default to location if there is a bbox and no other parameters. Otherwise 
# relevancy if there is a keyword, otherwise popularity.
# NB This ties in with the default sort set in ckanext/dgu/plugin.py
bbox = request.params.get('ext_bbox')
search_params_apart_from_bbox_or_sort = [key for key, value in request.params.items() 
                                       if key not in ('ext_bbox', 'sort') and value != '']
sort_by_location_enabled = False #bool(bbox and not search_params_apart_from_bbox_or_sort)
sort_by = c.sort_by_fields or ('spatial' if sort_by_location_enabled else ('rank' if c.q else 'popularity'))
sort_by_location_disabled = 'Selecting a location in Map Based Search allows you to sort by similarity of location. It is not possible to combine this sort ordering with other search parameters.' if not sort_by_location_enabled else False
relevancy_disabled = 'Typing some text in the Search box allows you to sort by relevancy.' if not request.params.get('q') else False
?>
          <py:for each="field,title,order,disabled in [('rank','relevancy','desc',relevancy_disabled), ('popularity', 'popularity', 'desc', False), ('title_string','title','asc', False), ('metadata_modified','last updated','desc', False)]"> <!-- ('spatial','location','desc',sort_by_location_disabled) -->
            <?python
                label_attrs = {'class': "radio inline"}
                input_attrs = {}
                if field in sort_by:
                  input_attrs['checked'] = 'checked'
                if disabled:
                  input_attrs['disabled'] = 'disabled'
                  label_attrs['class'] += ' js-tooltip'
                  label_attrs['title'] = disabled
            ?>
            <label py:attrs="label_attrs">
              <input type="radio" name="dataset-results-sort" value="${c.sort_by([(field,order)])}" py:attrs="input_attrs"/>
              ${title}
            </label>
          </py:for>
        </div>

        ${package_list_from_dict(c.page.items)}
        <div class="ribbon-footer" py:if="c.page.item_count"></div>
        <py:with vars="pager = c.page.pager(q=c.q)">
          <div py:if="pager" class="pager-container">
            ${pager}
          </div>
        </py:with>
      </div>
    </div>

  </div>

  <py:def function="optional_feed">
  <link rel="alternate" type="application/atom+xml" title="${g.site_title} - Datasets found with custom search: '${c.search_url_params}'"
    href="${h.url(controller='feed', action='custom')}?${c.search_url_params}" />
  </py:def>

  <xi:include href="layout.html" />
</html>


