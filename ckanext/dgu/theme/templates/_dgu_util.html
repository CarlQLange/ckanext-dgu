<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:i18n="http://genshi.edgewall.org/i18n"
  xmlns:py="http://genshi.edgewall.org/"
  xmlns:xi="http://www.w3.org/2001/XInclude"
  py:strip=""
  >

  <!--! Herein can be found generic helper methods for a whole bunch of common
        templating issues -->

  <ul py:def="package_list_from_dict(packages)" py:with="basket=session.get('preview_list',[])" class="datasets">
   <li py:for="package in packages">
     <div class="dataset boxed" py:with="title=package.get('title') or package.get('name')">
     <div class="dataset-header">
       <img class="dataset-icon" src="/images/dataset-icon.png" />
        <h3 class="clearfix">
          ${h.link_to(title, h.url_for(controller='package', action='read', id=package.get('name')))}
        </h3>
     </div>
     <h4>
          <strong>Publisher</strong> 
          :&nbsp;
            <?python
              groups = package.get('groups', [])
              publishers = [ g for g in groups if g.get('type') == 'publisher' ]
              publisher = publishers[0] if publishers else {'name':'', 'title': ''}
            ?>
            <a href="${h.url_for(controller='ckanext.dgu.controllers.publisher:PublisherController', action='read', id=publisher.get('name', ''))}">
              ${publisher.get('title', '')}
            </a>
     </h4>
     <?python
              import ckanext.dgu.lib.helpers as dgu_helpers
              display_provider = False
              uklps = [d for d in package.get('extras', {}) if d['key'] == 'UKLP']
              is_uklp = uklps[0]['value'] == '"True"' if len(uklps) else False
              providers = [d for d in package.get('extras', {}) if d['key'] == 'provider']
              provider = providers[0]['value'] if len(providers) else ''
              display_provider = is_uklp or bool(provider)
              wms_querystring = dgu_helpers.get_wms_querystring(package)
     ?>
     <h4 py:if="display_provider"><strong>Provider:</strong> ${provider.strip('"')}</h4>
     <div class="dataset-description">
        ${h.markdown_extract(package.notes)}
     </div>
     <span style="display: none;" class="js-data-id">${package.id}</span>
     <span style="display: none;" class="js-data-title">${title}</span>
     <span style="display: none;" class="js-data-querystring">${wms_querystring}</span>
     <div class="map-buttons" py:if="wms_querystring">
       <a href="/data/map-preview?${wms_querystring}" class="btn btn-datagov btn-small btn-preview preview-now">preview now</a><img class="preview-stamp" src="/images/compass.png"/>
       <span class="preview-add js-dataset-${package.id}-add" 
             style="${'display: none' if package.id in basket else ''}">
             <button data-id="${package.id}" class="btn btn-datagov btn-small btn-preview btn-basket"><span>add to list</span></button><img class="preview-stamp" src="/images/compass-plus.png"/>
       </span>
       <span class="preview-remove js-dataset-${package.id}-remove" 
             style="${'' if package.id in basket else 'display: none;'}">
             <button data-id="${package.id}" class="btn btn-small btn-preview btn-basket"><span>remove from list</span></button><img class="preview-stamp" src="/images/compass-minus.png"/>
       </span>
     </div>
     <py:if test="package.get('resources', [])">
     <h4>Formats:
          <ul class="dataset-formats">
            <py:for each="resource in package.resources">
              <py:if test="resource.get('format')">
                <li><a href="${resource.get('url')}"
                  title="${resource.get('description')}">${resource.get('format')}</a></li>
              </py:if>
            </py:for>
          </ul>
        </h4>
     </py:if>
      <div class="owners">
      </div>
      <div class="clearfix"></div>
        <!--ul py:if="package.tags" class="tags">
          <li py:for="tag in package.tags">${tag.name}</li>
        </ul-->
     </div>
    </li>
  </ul>

  <py:def function="dgu_facet_sidebar(code, limit=5, label=lambda n: n, title=h.facet_title, if_empty=None, count_label=lambda c: ' (%d)'%c)">
      <div py:if="if_empty is not None or len(h.facet_items(c, code, limit=limit))" class="facet-box">
          <h4><img src="/images/arrow.png" class="arrow" /> ${title(code)}</h4>
          <ul class="facet-options">
              <li py:for="name, count in h.facet_items(c, code, limit=limit)"
                  py:if="not (code, name) in c.fields">
                    <a href="${c.drill_down_url(**{code: name})}">
                    <span py:if="'format' in code.lower()">${h.icon(h.format_icon(name))}</span>
                      ${label(name)}</a>${count_label(count)}
              </li>
          </ul>
          <p py:if="not len(h.facet_items(c, code, limit=limit))">${if_empty}</p>
      </div>
  </py:def>


  <div py:def="facet_filters()" class="datasets">

    ${dgu_facet_sidebar('license_id-is-ogl', title=lambda n: 'Licence', label=lambda n: 'Open Government Licence' if n == 'true' else 'Non-Open Government Licence', if_empty='There are no further licence filters to apply.')}

    ${dgu_facet_sidebar('tags', if_empty='There are no further tag filters to apply.')}

    ${dgu_facet_sidebar('res_format', title=lambda n:'Resource Format', if_empty='There are no further resource format filters to apply.', count_label=lambda c: '')}

    ${dgu_facet_sidebar('publisher', label=h.group_name_to_title, if_empty='There are no further publisher filters to apply.', limit=5)}

    <div class="facet-box" id="map-based-search">
      <h4><img src="/images/arrow.png" class="arrow"/> UK Location Map Search</h4>
      <p>
        <py:if test="'ext_bbox' not in request.params">
          <a href="${c.drill_down_url(alternative_url='/data/map-based-search')}">Conduct Map Based Search</a>
        </py:if>
        <py:if test="'ext_bbox' in request.params">
          A Location has already been selected.
        </py:if>
      </p>
    </div>

    <!-- Create a nested list of UKLP filters -->
    <div class="facet-box">
      <h4><img src="/images/arrow.png" class="arrow"/> UK Location Dataset Type</h4>
      <ul py:if="len(h.facet_items(c, 'resource-type'))">
        ${facet_list_items('UKLP', label=lambda n: 'UKLP', if_empty='UKLP')}
        <ul class="facet-options">
          ${facet_list_items('resource-type')}
        </ul>
      </ul>
      <p py:if="not len(h.facet_items(c, 'resource-type'))">There are no further type filters to apply.</p>
    </div>

  </div>

</html>
